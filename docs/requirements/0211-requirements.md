# 0211版需求文档

- [0211版需求文档](#0211%e7%89%88%e9%9c%80%e6%b1%82%e6%96%87%e6%a1%a3)
- [1. 概念](#1-%e6%a6%82%e5%bf%b5)
  - [1.1 系统（System）](#11-%e7%b3%bb%e7%bb%9fsystem)
  - [1.2 域（Domain）](#12-%e5%9f%9fdomain)
  - [1.3 项目（Project）](#13-%e9%a1%b9%e7%9b%aeproject)
  - [1.4 用户（User）](#14-%e7%94%a8%e6%88%b7user)
  - [1.5 角色（Role）](#15-%e8%a7%92%e8%89%b2role)
  - [1.6 范围（Scope）](#16-%e8%8c%83%e5%9b%b4scope)
  - [1.7 资源和资源定价](#17-%e8%b5%84%e6%ba%90%e5%92%8c%e8%b5%84%e6%ba%90%e5%ae%9a%e4%bb%b7)
  - [1.8 分配和使用](#18-%e5%88%86%e9%85%8d%e5%92%8c%e4%bd%bf%e7%94%a8)
  - [1.9 计费周期 (Billing Cycle) 和付款用户 (Pay User)](#19-%e8%ae%a1%e8%b4%b9%e5%91%a8%e6%9c%9f-billing-cycle-%e5%92%8c%e4%bb%98%e6%ac%be%e7%94%a8%e6%88%b7-pay-user)
  - [1.10 使用周期 (Use Cycle)](#110-%e4%bd%bf%e7%94%a8%e5%91%a8%e6%9c%9f-use-cycle)
  - [1.11 区分计费周期和使用周期](#111-%e5%8c%ba%e5%88%86%e8%ae%a1%e8%b4%b9%e5%91%a8%e6%9c%9f%e5%92%8c%e4%bd%bf%e7%94%a8%e5%91%a8%e6%9c%9f)
  - [1.12 管理费](#112-%e7%ae%a1%e7%90%86%e8%b4%b9)
- [2. 参与者](#2-%e5%8f%82%e4%b8%8e%e8%80%85)
  - [2.1 系统管理员（System Admin）](#21-%e7%b3%bb%e7%bb%9f%e7%ae%a1%e7%90%86%e5%91%98system-admin)
  - [2.2 域管理员（Domain Admin）](#22-%e5%9f%9f%e7%ae%a1%e7%90%86%e5%91%98domain-admin)
  - [2.3 项目管理员（Project Admin）](#23-%e9%a1%b9%e7%9b%ae%e7%ae%a1%e7%90%86%e5%91%98project-admin)
  - [2.4 普通用户（User）](#24-%e6%99%ae%e9%80%9a%e7%94%a8%e6%88%b7user)
- [3. 功能列表](#3-%e5%8a%9f%e8%83%bd%e5%88%97%e8%a1%a8)
  - [3.1 资源管理](#31-%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86)
  - [3.2 系统管理员（System Admin）](#32-%e7%b3%bb%e7%bb%9f%e7%ae%a1%e7%90%86%e5%91%98system-admin)
  - [3.3 域管理员（Domain Admin）](#33-%e5%9f%9f%e7%ae%a1%e7%90%86%e5%91%98domain-admin)
  - [3.4 项目管理员（Project Admin）](#34-%e9%a1%b9%e7%9b%ae%e7%ae%a1%e7%90%86%e5%91%98project-admin)
  - [3.5 加入项目的普通用户（User）](#35-%e5%8a%a0%e5%85%a5%e9%a1%b9%e7%9b%ae%e7%9a%84%e6%99%ae%e9%80%9a%e7%94%a8%e6%88%b7user)
  - [3.6 未加入项目的普通用户（User）](#36-%e6%9c%aa%e5%8a%a0%e5%85%a5%e9%a1%b9%e7%9b%ae%e7%9a%84%e6%99%ae%e9%80%9a%e7%94%a8%e6%88%b7user)


# 1. 概念

## 1.1 系统（System）

指整个云平台，由多个域组成。

## 1.2 域（Domain）

对应学校，由项目和用户组成。

其中包括特殊的域：**社会（social）域**，所有新注册的用户默认加入社会域。

用户可以自行加入其他域，（应通过进行学校身份认证（通过CARSI）后，暂时不实现）。用户可以加入多个域，也可以选择退出除了社会域之外的任何域。

## 1.3 项目（Project）

项目，由用户组成，必须属于且只属于一个域。

## 1.4 用户（User）

- 指单个用户
- 可以被域管理员分配到多个项目中
- 除了**域默认管理员和系统管理员**外，其他用户至少属于一个域
- 每个用户可以在多种上下文（域、项目）中处于不同角色，但若在一个上下文中为管理员，其同时具有成员的所有功能。

## 1.5 角色（Role）

角色指在不同上下文（系统、域、项目）下的权限，包括管理员、成员两种角色。不同上下文下的管理员的能力不同，详情见下。

一般来说，具有管理员权限的用户可以进行成员的所有行为。

每个用户可以在不同的上下文下有不同的角色。

一个用户在一个上下文中只能又一个角色，即只可能为一个上下文的管理员或者成员，不能二者都是。

## 1.6 范围（Scope）

范围为一个（域、Optional<项目>、角色）三元组。每次用户操作都必须指定操作范围。系统将会根据指定的操作范围，显示用户可以操作的功能。

## 1.7 资源和资源定价

系统存在计费收费功能。

资源指系统提供的云资源，资源定价是指系统对资源的定价。系统采用同一资源统一定价，不支持动态调价。下表包括了资源种类和对应价格：

| 资源 | 单位（均为每小时） | 价格      |
| ---- | ------------------ | --------- |
| CPU  | 1核                | 0.01元    |
| 内存 | 1 MB               | 0.00001元 |
| 硬盘 | 1 GB               | 0.001元   |

## 1.8 分配和使用

**分配**，指上级对下级（系统对域，域对项目，项目对用户）分配的可使用的资源。

**使用**，指用户实际使用的资源（例如，创建的实例、创建的虚拟机、分配到实例的浮动IP个数）。

用户必须在项目中才可以使用资源，且只能使用属于项目的、被项目分配给用户的资源。

## 1.9 计费周期 (Billing Cycle) 和付款用户 (Pay User)

每一个计费周期，系统管理员对域管理员、域管理员对项目管理员将会根据系统对域、域对项目**分配的资源**（注意，并非使用的资源）进行收费。

每一个计费周期为一个小时。每一小时，计费周期重置。另外，每次上级管理员修改分配的资源后，计费周期也会重置一次。

每次重置时，按照1.6中提到的资费标准，上级对下级扣一次费。不足1小时的资源，按1小时的价格收费。

扣费时，系统将会减去下级的一个被设定为**付款用户**的管理员用户中对应的余额，并将上级的被设定为**付款用户**的管理员的账号中加入对应的余额。

若扣款时，下级付款用户的管理员用户中的余额小于应扣款的余额，此账号的余额将减为负，且账号、以及账号对应的上下文（域或者项目）下所有的资源会将会被停用，只开放充值功能。账号以及被停用的资源必须在充值使余额大于等于0后才能继续使用。

## 1.10 使用周期 (Use Cycle)

系统实际扣费是以被**分配的资源**为标准，而非**实际使用的资源**。例如，若A域给B项目分配了2核CPU，但是B项目下的所有用户只用了1核CPU，其收费标准是**2核CPU**，而非**1核CPU**。

为了帮助用户和管理员了解自己实际使用的情况，系统使用**使用周期**概念，按照实际使用的资源进行统计和计费。注意，此数据只用于展示，不用于实际计费。

每一个使用周期为一个小时。每一小时，计费周期重置。另外，每次用户使用资源的改变（增加一个实例、删除一个实例）时，用户在这个项目下的使用周期，包括对应项目和项目对应的域的使用周期也会重置。

使用周期计费所使用的计费计划目前和计费周期相同。

每个使用周期重置时，将会计算这段周期内实际使用的资源对应的费用。对于域和项目来说，它们的实际使用的资源为其下所有项目的所有用户在对应项目的资源量的总和。

可以把使用周期和计费周期看成两个完全无关的周期。

## 1.11 区分计费周期和使用周期

若假设CPU使用单价为1元1核1小时

| 时间  | 操作                            | 计费周期     | 使用周期     | 分配的资源 | 使用的资源 | 项目应给域付费                                  | 使用周期计费                                |
| ----- | ------------------------------- | ------------ | ------------ | ---------- | ---------- | ----------------------------------------------- | ------------------------------------------- |
| 00:00 | 域创建项目                      | 1开始        | 1开始        | 2核        | 0核        | 0元                                             | 0元                                         |
| 00:01 | 项目下某个用户创建了1核的虚拟机 |              | 1结束，2开始 |            | 1核        |                                                 | 0元（使用周期1，0核）                       |
| 01:00 | 计费周期结束                    | 1结束，2开始 |              |            |            | 2元（计费周期1，分配2核，1个小时）              |                                             |
| 01:01 | 使用周期结束                    |              | 2结束，3开始 |            |            |                                                 | 1元（使用周期2，1核）                       |
| 01:10 | 域给项目多分配2核               | 2结束，3开始 |              | 4核        |            | 2元（计费周期2，分配2核，不足1个小时按1个小时） |                                             |
| 01:40 | 项目下那个用户删除1核的虚拟机   |              | 3结束，4开始 |            | 0核        |                                                 | 1元（使用周期3，使用1核，不足1小时按1小时） |
| 02:10 | 计费周期结束                    | 3结束，4开始 |              |            |            | 4元（计费周期3，分配4核）                       |                                             |
| 02:40 | 使用周期结束                    |              | 4结束，5开始 |            |            |                                                 | 0元（使用周期4，0核）                       |
| 03:10 | 计费周期结束                    | 4开始        |              |            |            | 4元（计费周期4，分配4核）                       |                                             |

## 1.12 管理费

系统每一个月收取管理费。其中价位为：

| 上下文 | 价格     |
| ------ | -------- |
| 用户   | 1元/月   |
| 项目   | 10元/月  |
| 域     | 100元/月 |

项目和域将会向对应的付款用户收取管理费。

根据以上标准，社会域中的所有用户的管理费为（项目+用户）=11元/月。

# 2. 参与者

## 2.1 系统管理员（System Admin）

- 云管理员不属于任意一个域
- 可以创建、删除、修改、查域
- 可以给域分配资源（资源见下面收费部分）
- 根据给域分配的资源，向域收取费用（详情见1.1.6和1.1.8部分，下同）。

## 2.2 域管理员（Domain Admin）

域管理员指属于某个域的、并在域中的角色为**管理员**的用户。

**域管理员** 用户可以（包括**域默认管理员**，除了社会域管理员，见下）：
- 查询域下的用户
- 给域下的用户设置成域理员
- 设置域的付款用户
- 增删改查域下的项目
- 给用户分配到项目中并指定角色
- 对项目分配资源
- 根据给项目分配的资源，向项目管理员进行收费

**社会域管理员**用户不对外开放，其为系统自动控制，作用为：
- 中转社会域中的项目管理员支付的费用给系统（见计费部分）
- 根据社会域中的项目管理员增加和删除资源的请求调整社会域中的项目限额（见项目管理员）

## 2.3 项目管理员（Project Admin）

项目管理员指属于某个项目的、并在域中的角色为**管理员**的用户。

**项目管理员** 用户（除了社会域，见下）可以
- 查询域中的所有项目
- 查询域中的所有用户
- 向项目中增加用户
- 从项目中删除用户
- 给用户分配在项目里的角色（管理员或者成员）
- 给用户限制可以使用的资源
- 使用资源和个人信息管理（见下普通用户部分）

用户初注册时，其自动加入**社会域**，并自动成为**社会域**中一个只属于自己的项目的管理员。

**社会域项目管理员**只能进行：
- 充值
- 使用资源

每当社会域项目管理员创建/删除资源的时候，其将会自动向**社会域管理员**发起请求，社会域管理员将会根据其请求调整对其项目的限额，以使社会域项目管理员只支付自己真正所使用部分的限额。

社会域本身可以使用的资源有限制，并且其资源优先级低于普通域，所以社会域项目管理员创建资源的请求可能会失败。

## 2.4 普通用户（User）

加入项目的普通用户和项目管理员用户（包括社会域项目管理员）都可以**使用资源**，其中包括：

- 实例（Instance）
  - 实例创建，开机，关机，连接，删除
- 云硬盘（Volume）管理
  - 硬盘创建，连接到实例，管理实例已经连接的硬盘，扩容硬盘，删除硬盘
- 网络管理
  - 创建私有网络，将实例连接到私有网络，给私有网络分配浮动IP池，给实例分配浮动IP，给网络和浮动IP进行带宽限制
- 镜像（Image）管理
  - 创建镜像，以镜像创建实例，以镜像创建云硬盘

普通用户可以使用的资源为项目管理员分配的资源。对项目管理员用户来说，可使用的资源为项目的资源减去分配给其他用户的资源后剩余的资源。

未加入项目的用户（即以范围（域，null，成员）进行操作的用户）不能使用资源。

所有普通用户（包括未加入项目的成员）和所有项目管理员用户（包括社会域项目管理员）还可以进行**个人信息管理**：
- 修改个人信息（密码、邮箱、学号工号）
- 加入和退出除社会域之外的域
- 查询域中的所有项目和用户（社会域项目管理员不能进行）

# 3. 功能列表

## 3.1 资源管理

资源管理提供给加入项目的用户，所有用户的资源管理功能是一样的。

- 总览（Overview，个人目前已经使用的资源和被分配的资源（CPU、内存、硬盘，这些信息可以直接从Expenses里拿），列出所有实例）
- 实例（Instance）管理
  - 显示所有实例
  - 创建实例（名字、flavor（从已经有的flavor中选择）、Image/Volume，创建后自动从IP池里给一个公网IP）
  - 开启实例、关闭实例、重启实例
  - 删除实例
- 云硬盘（Volume）管理
  - 查看各个云硬盘、他们连接上的实例以及在实例上的挂载路径

## 3.2 系统管理员（System Admin）

- 用户管理（Identity）
  - 账号管理（Account）
    - 基本信息（Basic）：修改邮箱、姓名、密码
  - 域管理（Domains，增删改查域，给域设置管理员，给域分配资源）
  - 用户管理（Users，查询系统中的用户（显示ID、用户名、状态），从系统中删除用户）
- 费用管理（Expenses）
  - 总览（Overview，显示账号余额，提供充值入口；显示系统交易记录前5，可以跳到系统交易记录）
  - 账号交易记录（Account Transactions，提供当前账号的交易信息：时间、交易额、原因）
  - 系统交易记录（System Transactions，提供系统的交易记录（时间，支付人，费用，原因（管理费、域资源收入））
  - 域计费（Domains，分为分配和使用，分开显示）
    - 分配（Allocated，显示各个**域**当前**计费周期**中**分配的资源**、**费率**、**当前支付人**。可以选择一个域，显示之前每个**计费周期**域**分配的资源**、**费用**、**支付人**）（和每个域的信息域管理员的域计费的内容是一样的）
    - 使用（Used，显示各个**域**当前**使用周期**中**使用的资源**、**分配资源应交的费用**。可以选择一个**域**，显示之前每个**使用周期**域**使用的资源**和**费用**）


## 3.3 域管理员（Domain Admin）

- 用户管理（Identity）
  - 账号管理（Account）
    - 基本信息（Basic）：修改邮箱、姓名、密码
    - 加入域（Joined Domains）管理：查看已经加入的域和在各个域之中的权限，申请加入新的域
  - 项目管理（Projects，增删改查项目，修改给项目分配的资源，给用户分配到项目中并指定角色）
  - 用户管理（Users，查询域中的用户（显示ID、用户名、状态），从域中删除用户）
- 费用管理（Expenses）
  - 总览（Overview，显示账号余额，提供充值入口；显示域当前计费周期的信息，可以跳到域计费部分）
  - 账号交易记录（Account Transactions，提供**当前账号的交易信息**：时间、交易额、原因）
  - 域交易记录（Domain Transactions，**和当前域有关（项目给域钱、域给云钱，管理费）的交易记录**：时间、支付人、接收人、费用、原因（管理费、项目资源收入、域资源支出）
  - 域计费（Domain）
    - 分配（Allocated，显示当前域**计费周期**中**分配的资源**和**应交的费用**和**支付人**，可以修改付款用户。再显示当前**域**之前所有**计费周期**被**分配的资源**和**费用**以及**支付人**。）
    - 使用（Used，显示当前域**使用周期**中**使用的资源**和**分配资源应交的费用**。再显示当前**域**之前所有**使用周期**的**使用的资源**和**费用**。）
  - 项目计费（Projects）
    - 分配（Allocated，显示各个项目当前**计费周期**中**分配的资源**、**应交的费用**、**当前支付人**。可以选择一个**项目**，显示之前每个**计费周期**项目**分配的资源**、**费用**、**支付人**）
    - 使用（Used，显示各个项目当前**使用周期**中**使用的资源**和**费率**。可以选择一个**项目**，显示之前每个**使用周期**项目**使用的资源**和对应**费用**）

## 3.4 项目管理员（Project Admin）

- 用户管理（Identity）
  - 账号管理（Account）
    - 基本信息（Basic）：修改邮箱、姓名、密码
    - 加入域（Joined Domains）管理：查看已经加入的域和在各个域之中的权限，申请加入新的域
  - 项目管理（Projects，显示域中的所有项目，只读，对社会域隐藏）
  - 用户管理（Users，查询项目中的用户（显示ID、用户名、状态、角色），向项目中增加用户，从项目中删除用户，给项目中的用户设定项目的角色，给项目中的用户限制可以使用的资源，对社会域项目管理员隐藏）
- 费用管理（Expenses）
  - 总览（Overview，显示账号余额，提供充值入口；显示项目当前计费周期的信息（见下Project/Allocated），可以跳到Project部分）
  - 账号交易记录（Account Transactions，提供**当前账号的交易信息**：时间、交易额、原因）
  - 项目交易记录（Project Transactions，和**和当前项目有关（项目给域钱，管理费）的交易记录**：时间、支付人、接收人、费用、原因（管理费、项目资源支出））
  - 项目计费（Project）
    - 分配（Allocated，显示当前项目**计费周期**的**分配的资源**和**应交的费用**和**支付人**，可以修改支付人。再显示当前**项目**之前所有**计费周期**被**分配的资源**和**费用**以及**支付人**。）
    - 使用（Used，显示当前项目**使用周期**的**使用的资源**和**分配资源应交的费用**。再显示当前**项目**之前所有**使用周期**的**使用的资源**和**费用**。）
  - 用户计费（Users）
    - 分配（Allocated，显示各个用户当前**计费周期**中的**分配的资源**，**费率**。可以选择一个**用户**，显示之前每个**计费周期**用户**分配的资源**和**费率**。）
    - 使用（Users，显示各个用户当前**使用周期**实际使用的**资源**，**费率**。可以选择一个**用户**，显示之前每个**使用周期**用户**使用的资源**和**费率**。）
- 资源管理（Resources）

## 3.5 加入项目的普通用户（User）

- 用户管理（Identity）
  - 账号管理（Account）
    - 基本信息（Basic）：修改邮箱、姓名、密码
    - 加入域（Joined Domains）管理：查看已经加入的域和在各个域之中的权限，申请加入新的域
  - 项目管理（Projects，显示Domain中的所有Projects，只读）
  - 用户管理（Users，显示当前project的用户（ID、姓名、状态、角色），只读）
- 费用管理（Expenses）
  - 总览（Overview，显示账号余额，提供充值入口；显示账号交易记录前5）
  - 账号交易记录（Account Transactions，提供当前账号的交易信息：时间、交易额、原因（管理费））
  - 用户计费（User）
    - 分配（Allocated，显示当前用户**计费周期**的**分配的资源**和**应交的费用**。再显示当前用户之前所有**计费周期**被**分配的资源**和**费用**。）
    - 使用（Used，显示当前用户**使用周期**的**已被使用的资源**和**分配资源应交的费用**。再显示当前用户之前所有**使用周期**的**使用的资源**和**费用**。）
- 资源管理（Resources）

## 3.6 未加入项目的普通用户（User）

- 用户管理（Identity）
  - 账号管理（Account）
    - 基本信息（Basic）：修改邮箱、姓名、密码
    - 加入域（Joined Domains）管理：查看已经加入的域和在各个域之中的权限，申请加入新的域
  - 项目管理（Projects，显示Domain中的所有Projects，只读）
  - 用户管理（Users，显示Doamin里的所有用户，只读）
- 费用管理（Expenses）
  - 总览（Overview，显示账号余额，提供充值入口；显示账号交易记录前5）
  - 账号交易记录（Account Transactions，提供当前账号的交易信息：时间、交易额、原因（管理费）、余额）